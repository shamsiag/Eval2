{"ast":null,"code":"import { resolveComponent as _resolveComponent, createVNode as _createVNode, createElementVNode as _createElementVNode, renderList as _renderList, Fragment as _Fragment, openBlock as _openBlock, createElementBlock as _createElementBlock, createBlock as _createBlock, createCommentVNode as _createCommentVNode, vModelText as _vModelText, withDirectives as _withDirectives } from \"vue\";\nconst _hoisted_1 = {\n  class: \"cart-page\"\n};\nconst _hoisted_2 = {\n  key: 0,\n  class: \"cart-container\"\n};\nconst _hoisted_3 = {\n  key: 2,\n  class: \"modal-backdrop\"\n};\nconst _hoisted_4 = {\n  class: \"modal-content\"\n};\nconst _hoisted_5 = {\n  class: \"modal-actions\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_NavBar = _resolveComponent(\"NavBar\");\n  const _component_CartItem = _resolveComponent(\"CartItem\");\n  const _component_CartSummary = _resolveComponent(\"CartSummary\");\n  const _component_EmptyCartMessage = _resolveComponent(\"EmptyCartMessage\");\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createVNode(_component_NavBar), _cache[5] || (_cache[5] = _createElementVNode(\"h1\", {\n    class: \"cart-title\"\n  }, \"Votre panier\", -1 /* HOISTED */)), $data.cart.length > 0 ? (_openBlock(), _createElementBlock(\"div\", _hoisted_2, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($data.cart, item => {\n    return _openBlock(), _createBlock(_component_CartItem, {\n      key: item.rowid,\n      \"line-id\": item.rowid,\n      name: item.label,\n      description: item.description,\n      \"price-ttc\": parseFloat(item.total_ttc / item.qty),\n      quantity: item.qty,\n      image: item.photo,\n      onRemove: $options.removeItem\n    }, null, 8 /* PROPS */, [\"line-id\", \"name\", \"description\", \"price-ttc\", \"quantity\", \"image\", \"onRemove\"]);\n  }), 128 /* KEYED_FRAGMENT */)), _createVNode(_component_CartSummary, {\n    \"total-price\": $options.calculateTotal(),\n    onValidate: $options.openCheckoutModal\n  }, null, 8 /* PROPS */, [\"total-price\", \"onValidate\"])])) : (_openBlock(), _createBlock(_component_EmptyCartMessage, {\n    key: 1\n  })), $data.showModal ? (_openBlock(), _createElementBlock(\"div\", _hoisted_3, [_createElementVNode(\"div\", _hoisted_4, [_cache[3] || (_cache[3] = _createElementVNode(\"h2\", null, \"Finaliser votre commande\", -1 /* HOISTED */)), _cache[4] || (_cache[4] = _createElementVNode(\"label\", {\n    for: \"clientName\"\n  }, \"Entrez votre nom :\", -1 /* HOISTED */)), _withDirectives(_createElementVNode(\"input\", {\n    id: \"clientName\",\n    \"onUpdate:modelValue\": _cache[0] || (_cache[0] = $event => $data.clientName = $event),\n    placeholder: \"Votre nom complet\"\n  }, null, 512 /* NEED_PATCH */), [[_vModelText, $data.clientName]]), _createElementVNode(\"div\", _hoisted_5, [_createElementVNode(\"button\", {\n    onClick: _cache[1] || (_cache[1] = (...args) => $options.processOrder && $options.processOrder(...args))\n  }, \"Valider\"), _createElementVNode(\"button\", {\n    onClick: _cache[2] || (_cache[2] = (...args) => $options.closeCheckoutModal && $options.closeCheckoutModal(...args))\n  }, \"Annuler\")])])])) : _createCommentVNode(\"v-if\", true)]);\n}","map":{"version":3,"names":["class","key","_createElementBlock","_hoisted_1","_createVNode","_component_NavBar","_createElementVNode","$data","cart","length","_hoisted_2","_Fragment","_renderList","item","_createBlock","_component_CartItem","rowid","name","label","description","parseFloat","total_ttc","qty","quantity","image","photo","onRemove","$options","removeItem","_component_CartSummary","calculateTotal","onValidate","openCheckoutModal","_component_EmptyCartMessage","showModal","_hoisted_3","_hoisted_4","for","id","_cache","$event","clientName","placeholder","_hoisted_5","onClick","args","processOrder","closeCheckoutModal","_createCommentVNode"],"sources":["/Users/macbookpro/Sham/S6/Eval2-1/frontend/src/views/CartPage.vue"],"sourcesContent":["<template>\n    <div class=\"cart-page\">\n      <NavBar />\n  \n      <h1 class=\"cart-title\">Votre panier</h1>\n  \n      <div v-if=\"cart.length > 0\" class=\"cart-container\">\n        <CartItem\n          v-for=\"item in cart\"\n          :key=\"item.rowid\"\n          :line-id=\"item.rowid\"\n          :name=\"item.label\"\n          :description=\"item.description\"\n          :price-ttc=\"parseFloat(item.total_ttc / item.qty)\"\n          :quantity=\"item.qty\"\n          :image=\"item.photo\"\n          @remove=\"removeItem\"\n        />\n        <CartSummary :total-price=\"calculateTotal()\" @validate=\"openCheckoutModal\"/>\n      </div>\n  \n      <EmptyCartMessage v-else />\n\n      <div v-if=\"showModal\" class=\"modal-backdrop\">\n      <div class=\"modal-content\">\n        <h2>Finaliser votre commande</h2>\n        <label for=\"clientName\">Entrez votre nom :</label>\n        <input id=\"clientName\" v-model=\"clientName\" placeholder=\"Votre nom complet\" />\n        <div class=\"modal-actions\">\n          <button @click=\"processOrder\">Valider</button>\n          <button @click=\"closeCheckoutModal\">Annuler</button>\n        </div>\n      </div>\n    </div>\n\n    </div>\n  </template>\n  \n  <script>\n  import NavBar from \"@/components/NavBar.vue\";\n  import CartItem from \"@/components/CartItem.vue\";\n  import CartSummary from \"@/components/CartSummary.vue\";\n  import EmptyCartMessage from \"@/components/EmptyCartMessage.vue\";\n  \n  export default {\n    name: \"CartPage\",\n    components: {\n      NavBar,\n      CartItem,\n      CartSummary,\n      EmptyCartMessage,\n    },\n    data() {\n      return {\n        cart: [],\n        showModal: false,\n      clientName: '',\n      authToken: localStorage.getItem('authToken'),\n      apiLink: localStorage.getItem('apiLink') || 'http://localhost:8080/api/v1'\n      };\n    },\n    created() {\n    this.loadCartFromStorage();\n  },\n  methods: {\n    loadCartFromStorage() {\n      const stored = localStorage.getItem(\"cartItems\");\n      try {\n        this.cart = stored ? JSON.parse(stored) : [];\n      } catch (e) {\n        console.error(\"Impossible de parser le panier depuis localStorage\", e);\n        this.cart = [];\n      }\n    },\n\n    saveCartToStorage() {\n      try {\n        localStorage.setItem(\"cartItems\", JSON.stringify(this.cart));\n      } catch (e) {\n        console.error(\"Erreur lors de la sauvegarde du panier\", e);\n      }\n    },\n\n    removeItem(id) {\n      this.cart = this.cart.filter(item => item.id !== id);\n      this.saveCartToStorage();\n    },\n\n    calculateTotal() {\n      return this.cart\n        .reduce((sum, item) => sum + item.qty * parseFloat(item.price_ttc || 0), 0)\n        .toFixed(2);\n    },\n\n    validateCart() {\n      // TODO : implémenter envoi de commande ou redirection\n      alert(\"Commande validée !\");\n    },\n    openCheckoutModal() {\n      this.showModal = true;\n    },\n    closeCheckoutModal() {\n      this.showModal = false;\n      this.clientName = '';\n    },\n    async processOrder() {\n      if (!this.clientName) {\n        alert('Veuillez entrer votre nom.');\n        return;\n      }\n      try {\n        const headers = {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.authToken}`\n        };\n        // 1. Vérifier existence du client\n        const filter = encodeURIComponent(`name eq '${this.clientName}'`);\n        let res = await fetch(`${this.apiLink}/models/C_BPartner?$filter=${filter}`, { headers });\n        let bpData = await res.json();\n        let partnerId;\n        if (Array.isArray(bpData.records) && bpData.records.length > 0) {\n          partnerId = bpData.records[0].id;\n        } else {\n          // 2. Créer le client\n          res = await fetch(`${this.apiLink}/models/C_BPartner`, {\n            method: 'POST', headers,\n            body: JSON.stringify({\n              AD_Client_ID: { propertyLabel: \"Tenant\", id: 11, identifier: \"GardenWorld\", \"model-name\": \"ad_client\" },\n              AD_Org_ID: { propertyLabel: \"Organization\", id: 0, identifier: \"*\", \"model-name\": \"ad_org\" },\n              IsActive: true,\n              CreatedBy: { propertyLabel: \"Created By\", id: 100, identifier: \"SuperUser\", \"model-name\": \"ad_user\" },\n              Value: this.clientName.replace(/\\s+/g, ''),\n              Name: this.clientName,\n              IsCustomer: true,\n              IsDiscountPrinted: true,\n              C_BP_Group_ID: { propertyLabel: \"Business Partner Group\", id: 105, identifier: \"Staff\", \"model-name\": \"c_bp_group\" },\n              TotalOpenBalance: 0\n            })\n          });\n          const newBP = await res.json();\n          partnerId = newBP.id;\n        }\n        // 3. Créer une adresse\n        res = await fetch(`${this.apiLink}/models/C_Location`, {\n          method: 'POST', headers,\n          body: JSON.stringify({\n            AD_Client_ID: 11,\n            AD_Org_ID: 11,\n            IsActive: true,\n            CreatedBy: 100,\n            Address1: \"Address\",\n            City: \"City\",\n            C_Country_ID: 100,\n            C_Region_ID: 102,\n            Postal: \"06488\",\n            IsValid: false\n          })\n        });\n        const loc = await res.json();\n        // 4. Lier client-adresse\n        await fetch(`${this.apiLink}/models/C_BPartner_Location`, {\n          method: 'POST', headers,\n          body: JSON.stringify({\n            AD_Client_ID: 11,\n            AD_Org_ID: 11,\n            C_Location_ID: loc.id,\n            C_BPartner_ID: partnerId\n          })\n        });\n        // 5. Créer la commande\n        res = await fetch(`${this.apiLink}/models/c_order`, {\n          method: 'POST', headers,\n          body: JSON.stringify({\n            C_BPartner_ID: partnerId,\n            C_DocTypeTarget_ID: 132,\n            AD_Org_ID: 11,\n            M_Warehouse_ID: 50002\n          })\n        });\n        const order = await res.json();\n        // 6. Ajouter les lignes de commande\n        const orderLines = this.cart.map(item => ({\n          M_Product_ID: item.id,\n          QtyEntered: item.qty,\n          QtyOrdered: item.qty\n        }));\n        await fetch(`${this.apiLink}/models/C_Order/${order.id}`, {\n          method: 'PUT', headers,\n          body: JSON.stringify({\n            C_OrderLine: orderLines,\n            'doc-action': 'PR'\n          })\n        });\n        alert('Commande créée avec succès !');\n        this.cart = [];\n        this.saveCartToStorage();\n        this.closeCheckoutModal();\n        this.$router.push('/shop');\n      } catch (error) {\n        console.error('Erreur lors du checkout :', error);\n        alert('Une erreur est survenue lors de la validation de votre commande.');\n      }\n    }\n  }\n};\n</script>\n\n  \n  <style scoped>\n  .cart-page {\n    max-width: 900px;\n    margin: 0 auto;\n    padding: 20px;\n    color: #F6F6FE;\n  }\n  .cart-title {\n    font-size: 2rem;\n    margin-bottom: 20px;\n    color: #F6F6FE;\n  }\n  .cart-container {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n    color: #F6F6FE;\n  }\n  </style>\n  "],"mappings":";;EACSA,KAAK,EAAC;AAAW;;EAD1BC,GAAA;EAMkCD,KAAK,EAAC;;;EANxCC,GAAA;EAuB4BD,KAAK,EAAC;;;EACvBA,KAAK,EAAC;AAAe;;EAInBA,KAAK,EAAC;AAAe;;;;;;uBA3B9BE,mBAAA,CAkCM,OAlCNC,UAkCM,GAjCJC,YAAA,CAAUC,iBAAA,G,0BAEVC,mBAAA,CAAwC;IAApCN,KAAK,EAAC;EAAY,GAAC,cAAY,sBAExBO,KAAA,CAAAC,IAAI,CAACC,MAAM,Q,cAAtBP,mBAAA,CAaM,OAbNQ,UAaM,I,kBAZJR,mBAAA,CAUES,SAAA,QAjBVC,WAAA,CAQyBL,KAAA,CAAAC,IAAI,EAAZK,IAAI;yBADbC,YAAA,CAUEC,mBAAA;MARCd,GAAG,EAAEY,IAAI,CAACG,KAAK;MACf,SAAO,EAAEH,IAAI,CAACG,KAAK;MACnBC,IAAI,EAAEJ,IAAI,CAACK,KAAK;MAChBC,WAAW,EAAEN,IAAI,CAACM,WAAW;MAC7B,WAAS,EAAEC,UAAU,CAACP,IAAI,CAACQ,SAAS,GAAGR,IAAI,CAACS,GAAG;MAC/CC,QAAQ,EAAEV,IAAI,CAACS,GAAG;MAClBE,KAAK,EAAEX,IAAI,CAACY,KAAK;MACjBC,QAAM,EAAEC,QAAA,CAAAC;;kCAEXxB,YAAA,CAA4EyB,sBAAA;IAA9D,aAAW,EAAEF,QAAA,CAAAG,cAAc;IAAKC,UAAQ,EAAEJ,QAAA,CAAAK;6EAG1DlB,YAAA,CAA2BmB,2BAAA;IArBjChC,GAAA;EAAA,KAuBiBM,KAAA,CAAA2B,SAAS,I,cAApBhC,mBAAA,CAUI,OAVJiC,UAUI,GATJ7B,mBAAA,CAQM,OARN8B,UAQM,G,0BAPJ9B,mBAAA,CAAiC,YAA7B,0BAAwB,sB,0BAC5BA,mBAAA,CAAkD;IAA3C+B,GAAG,EAAC;EAAY,GAAC,oBAAkB,sB,gBAC1C/B,mBAAA,CAA8E;IAAvEgC,EAAE,EAAC,YAAY;IA3B9B,uBAAAC,MAAA,QAAAA,MAAA,MAAAC,MAAA,IA2BwCjC,KAAA,CAAAkC,UAAU,GAAAD,MAAA;IAAEE,WAAW,EAAC;iDAAxBnC,KAAA,CAAAkC,UAAU,E,GAC1CnC,mBAAA,CAGM,OAHNqC,UAGM,GAFJrC,mBAAA,CAA8C;IAArCsC,OAAK,EAAAL,MAAA,QAAAA,MAAA,UAAAM,IAAA,KAAElB,QAAA,CAAAmB,YAAA,IAAAnB,QAAA,CAAAmB,YAAA,IAAAD,IAAA,CAAY;KAAE,SAAO,GACrCvC,mBAAA,CAAoD;IAA3CsC,OAAK,EAAAL,MAAA,QAAAA,MAAA,UAAAM,IAAA,KAAElB,QAAA,CAAAoB,kBAAA,IAAApB,QAAA,CAAAoB,kBAAA,IAAAF,IAAA,CAAkB;KAAE,SAAO,E,SA9BrDG,mBAAA,e","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}